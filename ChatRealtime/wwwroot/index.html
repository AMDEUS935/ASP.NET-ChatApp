<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Chat Test</title>

    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <h2>채팅 테스트</h2>

    <!-- 상태 표시 -->
    <div id="status">상태: (처음 화면)</div>

    <input id="user" value="me" />
    <input id="msg" placeholder="message" />
    <button id="send" disabled>Send</button>

    <hr />
    <div id="log"></div>

    <!-- SignalR 라이브러리 (이게 있어야 conn 만들 수 있음) -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>

    <script>
        // ===== 화면 요소 잡기 =====
        const status = document.getElementById("status");
        const sendBtn = document.getElementById("send");
        const log = document.getElementById("log");

        // ===== 화면 로그 한 줄 추가 함수 =====
        function addLine(t) {
            const d = document.createElement("div");
            d.textContent = t;
            log.appendChild(d);
        }

        // ✅ 여기까지 바뀌면: "JS 실행은 됨" 이 확정
        status.textContent = "상태: JS 실행됨 ✅";

        // SignalR 라이브러리 로딩 확인
        if (typeof signalR === "undefined") {
            status.textContent = "상태: SignalR 로딩 실패 ❌";
            addLine("SignalR 파일을 못 불러왔어(인터넷/CDN 문제일 수 있음)");
            throw new Error("SignalR not loaded");
        }

        // 서버 허브 주소(Program.cs에서 /hubs/chat로 열어둠)
        const hubUrl = location.origin + "/hubs/chat";
        addLine("Hub: " + hubUrl);

        // ===== 서버로 연결 만들기 =====
        const conn = new signalR.HubConnectionBuilder()
            .withUrl(hubUrl)
            .withAutomaticReconnect()
            .build();

        // ===== 서버가 보내는 메시지 받기 =====
        conn.on("message", (user, message) => {
            addLine(user + ": " + message);
        });

        // ===== 연결 시작 =====
        status.textContent = "상태: 연결 시도 중...";
        conn.start().then(() => {
            status.textContent = "상태: 연결됨 ✅";
            sendBtn.disabled = false; // 연결된 다음에만 보내기 가능
            addLine("connected ✅");
        }).catch(err => {
            status.textContent = "상태: 연결 실패 ❌";
            addLine("연결 실패: " + err);
            alert("연결 실패: " + err);
        });

        // ===== 보내기 버튼 =====
        sendBtn.addEventListener("click", async () => {
            const user = document.getElementById("user").value;
            const msg = document.getElementById("msg").value;
            if (!msg) return;

            try {
                await conn.invoke("SendMessage", user, msg); // 서버 ChatHub.SendMessage 호출
                document.getElementById("msg").value = "";
            } catch (e) {
                addLine("보내기 실패: " + e);
                alert("보내기 실패: " + e);
            }
        });
    </script>
</body>
</html>

